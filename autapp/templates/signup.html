<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chiwe - Sign Up</title>
<style>
:root {
    --primary: #2ed573;
    --primary-dark: #25a85c;
    --primary-light: #7bed9f;
    --primary-glow: rgba(46, 213, 115, 0.4);
    --background: #0f0f13;
    --surface: #1a1a22;
    --surface-dark: #14141a;
    --text: #ffffff;
    --text-secondary: #a0aec0;
    --danger: #ff4757;
    --warning: #ffa502;
    --success: #2ed573;
    --border-radius: 12px;
    --card-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    --glow: 0 0 15px var(--primary-glow);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', 'Arial', sans-serif;
    -webkit-tap-highlight-color: transparent;
}

body {
    background-color: var(--background);
    color: var(--text);
    min-height: 100vh;
    line-height: 1.6;
    overflow-x: hidden;
    background-image: 
        radial-gradient(circle at 25% 25%, rgba(46, 213, 115, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, rgba(46, 213, 115, 0.05) 0%, transparent 50%);
    display: flex;
    align-items: center;
    justify-content: center;
}

.container {
    width: 100%;
    max-width: 450px;
    margin: 2rem;
    padding: 2rem;
}

.logo {
    text-align: center;
    margin-bottom: 2rem;
}

.logo-text {
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary);
    letter-spacing: 1px;
}

.card {
    background: var(--surface);
    border-radius: var(--border-radius);
    padding: 2rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--card-shadow);
    border: 1px solid rgba(255, 255, 255, 0.05);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card-header {
    text-align: center;
    margin-bottom: 1.5rem;
}

.card-title {
    font-size: 1.5rem;
    color: var(--text);
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.card-subtitle {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.form-group {
    margin-bottom: 1.5rem;
    position: relative;
}

.form-row {
    display: flex;
    gap: 1rem;
}

.form-row .form-group {
    flex: 1;
}

.form-label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text);
    font-weight: 500;
}

.form-input {
    width: 100%;
    padding: 0.75rem 1rem;
    background: var(--surface-dark);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--border-radius);
    color: var(--text);
    font-size: 1rem;
    transition: all 0.3s ease;
}

.form-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: var(--glow);
}

.form-input.error {
    border-color: var(--danger);
}

.error-message {
    color: var(--danger);
    font-size: 0.85rem;
    margin-top: 0.5rem;
    display: none;
}

.btn {
    width: 100%;
    padding: 0.85rem 1.5rem;
    border-radius: var(--border-radius);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.btn-primary {
    background: var(--primary);
    color: var(--background);
    border: none;
}

.btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(46, 213, 115, 0.3);
}

.btn-primary:active:not(:disabled) {
    transform: translateY(1px);
}

.btn-primary:disabled {
    background: var(--text-secondary);
    cursor: not-allowed;
}

.btn-link {
    background: transparent;
    color: var(--primary);
    border: none;
    padding: 0.5rem;
    font-size: 0.9rem;
    text-decoration: underline;
}

.btn-link:hover {
    color: var(--primary-light);
}

/* Loading Spinner */
.spinner {
    width: 20px;
    height: 20px;
    border: 3px solid rgba(0, 0, 0, 0.3);
    border-radius: 50%;
    border-top-color: var(--background);
    animation: spin 1s ease-in-out infinite;
    display: none;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Success Animation */
.checkmark {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: block;
    stroke-width: 2;
    stroke: var(--background);
    stroke-miterlimit: 10;
    box-shadow: inset 0px 0px 0px var(--primary);
    animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
    display: none;
}

.checkmark__circle {
    stroke-dasharray: 166;
    stroke-dashoffset: 166;
    stroke-width: 2;
    stroke-miterlimit: 10;
    stroke: var(--background);
    fill: none;
    animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
}

.checkmark__check {
    transform-origin: 50% 50%;
    stroke-dasharray: 48;
    stroke-dashoffset: 48;
    animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
}

@keyframes stroke {
    100% {
        stroke-dashoffset: 0;
    }
}

@keyframes scale {
    0%, 100% {
        transform: none;
    }
    50% {
        transform: scale3d(1.1, 1.1, 1);
    }
}

@keyframes fill {
    100% {
        box-shadow: inset 0px 0px 0px 30px var(--primary);
    }
}

/* Alert Message */
.alert {
    padding: 1rem;
    border-radius: var(--border-radius);
    margin-bottom: 1.5rem;
    font-weight: 500;
    display: none;
}

.alert-success {
    background: rgba(46, 213, 115, 0.1);
    color: var(--primary);
    border: 1px solid rgba(46, 213, 115, 0.3);
}

.alert-error {
    background: rgba(255, 71, 87, 0.1);
    color: var(--danger);
    border: 1px solid rgba(255, 71, 87, 0.3);
}

/* Fade In Animation */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.fade-in {
    animation: fadeIn 0.5s ease forwards;
}

/* Password Strength Indicator */
.password-strength {
    margin-top: 0.5rem;
    height: 5px;
    border-radius: 5px;
    background: var(--surface-dark);
    overflow: hidden;
}

.password-strength-bar {
    height: 100%;
    width: 0;
    transition: width 0.3s ease, background-color 0.3s ease;
}

.strength-weak {
    background-color: var(--danger);
    width: 33%;
}

.strength-medium {
    background-color: var(--warning);
    width: 66%;
}

.strength-strong {
    background-color: var(--success);
    width: 100%;
}

.password-tips {
    margin-top: 0.5rem;
    font-size: 0.8rem;
    color: var(--text-secondary);
}

/* Password visibility toggle */
.password-toggle {
    position: absolute;
    right: 12px;
    top: 38px;
    color: var(--text-secondary);
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.password-toggle:hover {
    color: var(--text);
}

/* Responsive Design */
@media (max-width: 480px) {
    .container {
        margin: 1rem;
        padding: 1rem;
    }

    .card {
        padding: 1.5rem;
    }
    
    .form-row {
        flex-direction: column;
        gap: 0;
    }
}
</style>
</head>
<body>
<div class="container">
    <div class="logo">
        <div class="logo-text">Chiwe</div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h1 class="card-title">Create Account</h1>
            <p class="card-subtitle">Sign up to get started with Chiwe</p>
        </div>
        
        <div id="alertMessage" class="alert"></div>
        
        <form id="signup-form">
            <!-- CSRF Token - Hidden field for Django -->
            <input type="hidden" name="csrfmiddlewaretoken" id="csrfToken" value="{{ csrf_token }}">
            
            <div class="form-row">
                <div class="form-group">
                    <label for="firstName" class="form-label">First Name</label>
                    <input type="text" id="firstName" name="first_name" class="form-input" placeholder="Enter your first name" required>
                    <div id="firstNameError" class="error-message">Please enter your first name</div>
                </div>
                
                
            </div>
            
            <div class="form-group">
                <label for="username" class="form-label">Username</label>
                <input type="text" id="username" name="username" class="form-input" placeholder="Choose a username" required>
                <div id="usernameError" class="error-message">Please enter a valid username</div>
            </div>
            
            <div class="form-group">
                <label for="email" class="form-label">Email Address</label>
                <input type="email" id="email" name="email" class="form-input" placeholder="Enter your email" required>
                <div id="emailError" class="error-message">Please enter a valid email address</div>
            </div>
            
            <div class="form-group">
                <label for="password" class="form-label">Password</label>
                <input type="password" id="password" name="password1" class="form-input" placeholder="Create a password" required>
                <button type="button" class="password-toggle" id="togglePassword">üëÅÔ∏è</button>
                <div class="password-strength">
                    <div id="passwordStrengthBar" class="password-strength-bar"></div>
                </div>
                <div class="password-tips">Password must be at least 8 characters long</div>
                <div id="passwordError" class="error-message">Password must be at least 8 characters long</div>
            </div>
            
            <div class="form-group">
                <label for="confirmPassword" class="form-label">Confirm Password</label>
                <input type="password" id="confirmPassword" name="password2" class="form-input" placeholder="Confirm your password" required>
                <button type="button" class="password-toggle" id="toggleConfirmPassword">üëÅÔ∏è</button>
                <div id="confirmPasswordError" class="error-message">Passwords do not match</div>
            </div>
            
            <button type="submit" id="signupBtn" class="btn btn-primary">
                <span>Create Account</span>
                <div id="signupSpinner" class="spinner"></div>
                <svg id="signupCheck" class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                    <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                    <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                </svg>
            </button>
        </form>
    </div>
    
    <div style="text-align: center;">
        <button id="loginLink" class="btn btn-link">Already have an account? Log in</button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM Elements
        const form = document.getElementById('signup-form');
        const csrfTokenInput = document.getElementById('csrfToken');
        const firstNameInput = document.getElementById('firstName');
        const usernameInput = document.getElementById('username');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const firstNameError = document.getElementById('firstNameError');
        const usernameError = document.getElementById('usernameError');
        const emailError = document.getElementById('emailError');
        const passwordError = document.getElementById('passwordError');
        const confirmPasswordError = document.getElementById('confirmPasswordError');
        const signupBtn = document.getElementById('signupBtn');
        const signupSpinner = document.getElementById('signupSpinner');
        const signupCheck = document.getElementById('signupCheck');
        const alertMessage = document.getElementById('alertMessage');
        const passwordStrengthBar = document.getElementById('passwordStrengthBar');
        const togglePassword = document.getElementById('togglePassword');
        const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
        const loginLink = document.getElementById('loginLink');
        
        
        if (!csrfTokenInput.value) {
            csrfTokenInput.value = getCookie('csrftoken');
            
            // If still no token, fetch a new one from the server
            if (!csrfTokenInput.value) {
                fetchCSRFToken();
            }
        }
        
        // Function to fetch a new CSRF token if needed
        function fetchCSRFToken() {
            fetch('/get-csrf-token/', {
                method: 'GET',
                credentials: 'same-origin' // Important for cookies
            })
            .then(response => response.json())
            .then(data => {
                if (data.csrf_token) {
                    csrfTokenInput.value = data.csrf_token;
                }
            })
            .catch(error => {
                console.error('Error fetching CSRF token:', error);
            });
        }
        
        // Email validation
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        // Password strength check
        function checkPasswordStrength(password) {
            if (!password) {
                passwordStrengthBar.className = 'password-strength-bar';
                passwordStrengthBar.style.width = '0';
                return;
            }
            
            if (password.length < 8) {
                passwordStrengthBar.className = 'password-strength-bar strength-weak';
                return 'weak';
            } else if (password.length < 10 || !/[A-Z]/.test(password) || !/[0-9]/.test(password)) {
                passwordStrengthBar.className = 'password-strength-bar strength-medium';
                return 'medium';
            } else {
                passwordStrengthBar.className = 'password-strength-bar strength-strong';
                return 'strong';
            }
        }
        
        // Show alert message
        function showAlert(message, type) {
            alertMessage.textContent = message;
            alertMessage.className = `alert alert-${type} fade-in`;
            alertMessage.style.display = 'block';
            
            // Auto hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    alertMessage.style.display = 'none';
                }, 5000);
            }
        }
        
        // Toggle password visibility
        togglePassword.addEventListener('click', function() {
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                this.textContent = 'üîí';
            } else {
                passwordInput.type = 'password';
                this.textContent = 'üëÅÔ∏è';
            }
        });
        
        toggleConfirmPassword.addEventListener('click', function() {
            if (confirmPasswordInput.type === 'password') {
                confirmPasswordInput.type = 'text';
                this.textContent = 'üîí';
            } else {
                confirmPasswordInput.type = 'password';
                this.textContent = 'üëÅÔ∏è';
            }
        });
        
        // Password strength check
        passwordInput.addEventListener('input', function() {
            checkPasswordStrength(this.value);
        });
        
        // Real-time password match validation
        confirmPasswordInput.addEventListener('input', function() {
            if (this.value && this.value !== passwordInput.value) {
                confirmPasswordInput.classList.add('error');
                confirmPasswordError.style.display = 'block';
            } else {
                confirmPasswordInput.classList.remove('error');
                confirmPasswordError.style.display = 'none';
            }
        });
        
        // Form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Reset validation state
            const inputs = form.querySelectorAll('.form-input');
            inputs.forEach(input => {
                input.classList.remove('error');
            });
            const errorMessages = form.querySelectorAll('.error-message');
            errorMessages.forEach(msg => {
                msg.style.display = 'none';
            });
            
            // Validate form
            let isValid = true;
            
            // First name validation
            if (!firstNameInput.value.trim()) {
                firstNameInput.classList.add('error');
                firstNameError.style.display = 'block';
                isValid = false;
            }
            
            // Username validation
            if (!usernameInput.value.trim() || usernameInput.value.trim().length < 3) {
                usernameInput.classList.add('error');
                usernameError.textContent = usernameInput.value.trim() ? 
                    'Username must be at least 3 characters' : 'Please enter a username';
                usernameError.style.display = 'block';
                isValid = false;
            }
            
            // Email validation
            if (!isValidEmail(emailInput.value.trim())) {
                emailInput.classList.add('error');
                emailError.style.display = 'block';
                isValid = false;
            }
            
            // Password validation
            if (passwordInput.value.length < 8) {
                passwordInput.classList.add('error');
                passwordError.style.display = 'block';
                isValid = false;
            }
            
            // Confirm password validation
            if (passwordInput.value !== confirmPasswordInput.value) {
                confirmPasswordInput.classList.add('error');
                confirmPasswordError.style.display = 'block';
                isValid = false;
            }
            
            if (!isValid) return;
            
            // Check if CSRF token is available
            if (!csrfTokenInput.value) {
                showAlert('Security token missing. Please refresh the page and try again.', 'error');
                return;
            }
            
            // Show loading state
            signupBtn.disabled = true;
            signupSpinner.style.display = 'block';
            
            // Prepare form data
            const formData = new FormData(form);
            
            // Send AJAX request
            fetch('/signup', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfTokenInput.value
                },
                credentials: 'same-origin' // Important for cookies
            })
            .then(response => {
                // Check if we need to update the CSRF token from response headers
                const newToken = response.headers.get('X-CSRFToken');
                if (newToken) {
                    csrfTokenInput.value = newToken;
                }
                return response.json();
            })
            .then(data => {
                // Reset loading state
                signupSpinner.style.display = 'none';
                
                // Check if this is an OTP verification response
                if (data.success === true && data.username && data.message && data.message.includes('OTP')) {
                    // Show success checkmark
                    signupCheck.style.display = 'block';
                    
                    // Show success message
                    showAlert(data.message, 'success');
                    
                    // Redirect to verification page after delay
                    setTimeout(() => {
                        window.location.href = `/verify/${data.username}`;
                    }, 2000);
                    return;
                }
                
                // Handle regular success response
                if (data.success) {
                    // Show success checkmark
                    signupCheck.style.display = 'block';
                    
                    // Show success message
                    showAlert(data.message || 'Account created successfully!', 'success');
                    
                    // Redirect to login page after delay
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                } else {
                    // Show error message
                    signupBtn.disabled = false;
                    showAlert(data.message || 'An error occurred. Please try again.', 'error');
                    
                    // If the error is related to email
                    if (data.message && data.message.toLowerCase().includes('email already exists')) {
                        emailInput.classList.add('error');
                        emailError.textContent = data.message;
                        emailError.style.display = 'block';
                    }
                    
                    // If the error mentions CSRF, try to refresh the token
                    if (data.message && data.message.toLowerCase().includes('csrf')) {
                        fetchCSRFToken();
                    }
                }
            })
            .catch(error => {
                // Handle network errors
                signupSpinner.style.display = 'none';
                signupBtn.disabled = false;
                showAlert('Network error. Please try again.', 'error');
                console.error('Error:', error);
                
                // Try to refresh the CSRF token in case that was the issue
                fetchCSRFToken();
            });
        });
        
        // Login link
        loginLink.addEventListener('click', function() {
            window.location.href = '/login';
        });
        
        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
</body>
</html>
